<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ShadowAI</title>
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Markdown Renderer -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Socket.io Library -->
    <script src="/socket.io/socket.io.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="/style.css">
</head>

<body>
    <div class="app-container">
        <!-- =========================================
             CONTROLS PANEL (Sidebar / Top on Mobile)
             ========================================= -->
        <div class="controls-panel">
            <div class="logo">
                <span>ShadowAI</span>
                <div class="header-actions">
                    <button class="icon-btn" id="settingsBtn" title="Settings"><i class="ph ph-gear"></i></button>
                </div>
            </div>

            <!-- Device Name & ID Display Component -->
            <div class="device-name-container"
                style="display:flex; gap:8px; flex-direction: column; align-items: stretch;">
                <div style="display:flex; gap:8px; width: 100%;">
                    <input type="text" id="deviceNameInput" placeholder="Device Name">
                    <button class="save-name-btn" id="saveNameBtn" title="Save Name"><i
                            class="ph ph-check"></i></button>
                </div>
                <div id="deviceIdDisplay" title="Click to Copy ID">
                    <span class="label">ID:</span>
                    <span id="deviceIdText">LOADING</span>
                    <i class="ph ph-copy"></i>
                </div>
            </div>

            <!-- Camera Controls -->
            <button id="cameraToggle">Start Camera</button>

            <!-- Mobile Action Buttons (Scan & Upload) -->
            <div class="mobile-action-btns" id="mobileActionBtns">
                <button class="primary-btn" id="captureBtn"><i class="ph ph-scan"></i> Scan</button>
                <label class="upload-btn" for="uploadInput"><i class="ph ph-upload"></i> Upload</label>
                <input type="file" id="uploadInput" accept="image/*" style="display:none;">
            </div>

            <!-- Camera Video Container -->
            <div class="camera-container" id="cameraContainer">
                <video id="video" autoplay playsinline muted></video>
                <div class="camera-controls">
                    <button class="cam-btn" id="camRotateBtn" title="Rotate"><i
                            class="ph ph-arrows-clockwise"></i></button>
                </div>
            </div>

            <!-- AI Model Options -->
            <div class="ai-options">
                <label>AI Provider & Model</label>
                <div class="seg-control">
                    <button class="seg-btn active" data-val="ollama">Ollama<span class="status-dot checking"
                            id="ollamaStatus"></span></button>
                    <button class="seg-btn" data-val="gemini">Gemini<span class="status-dot checking"
                            id="geminiStatus"></span></button>
                </div>
                <!-- Dynamic Model Select -->
                <div id="aiModelContainer" style="margin-top:5px;">
                    <select id="modelSelect"></select>
                </div>
            </div>
        </div>

        <!-- =========================================
             FEED PANEL (Main Content / Chat)
             ========================================= -->
        <div class="feed-panel" id="feedPanel">
            <!-- Live Processing Indicator -->
            <div class="result-card" id="liveProcessing" style="display:none; text-align:center;">
                <img id="processingImg" style="height:200px; max-width:100%; border-radius:8px; object-fit:contain;">
                <div style="margin-top:10px; color:var(--accent);">Analyzing...</div>
            </div>
            <!-- Initial Empty State -->
            <div id="placeholder" style="text-align:center; padding-top:50px; color:var(--text-secondary);">
                <h2>Ready to Sync</h2>
                <p style="margin-top:10px;">Scan a question from any device.</p>
            </div>
        </div>

        <!-- =========================================
             RIGHT COLUMN (Devices & History)
             ========================================= -->
        <div class="right-column-container">
            <!-- DEVICES PANEL -->
            <div class="devices-panel">
                <h4 style="margin-bottom:10px; color:var(--text-secondary);">Connected Devices</h4>
                <!-- Paring Input -->
                <div class="pairing-input-container">
                    <input type="text" class="pairing-input" id="pairingInput" placeholder="Enter Device ID to Pair">
                    <button class="pair-btn" id="pairBtn"><i class="ph ph-check"></i></button>
                </div>
                <div id="deviceList"></div>

                <!-- Available Devices (Discovery) -->
                <h4
                    style="margin:20px 0 10px; color:var(--text-secondary); font-size: 0.85rem; text-transform:uppercase; letter-spacing:1px;">
                    Available Devices</h4>
                <div id="availableDeviceList" style="display:flex; flex-direction:column; gap:8px;">
                    <div style="text-align:center; padding:10px; color:var(--text-secondary); font-size:0.8rem;">
                        Scanning for local devices...</div>
                </div>
            </div>
            <!-- HISTORY PANEL -->
            <div class="history-section">
                <h4 style="margin-bottom:10px; color:var(--text-secondary);">History</h4>
                <div id="historyList" style="display:flex; gap:10px; overflow-x:auto;"></div>
            </div>
        </div>
    </div>

    <!-- =========================================
         SETTINGS MODAL
         ========================================= -->
    <div class="modal-backdrop" id="settingsModal">
        <div class="modal-content" style="max-width:500px; max-height: 90vh; display: flex; flex-direction: column;">
            <div class="modal-body settings-grid" style="overflow-y:auto; padding: 25px;">
                <h3 style="margin-bottom:20px;">Settings</h3>
                <div>
                    <label>Theme</label>
                    <button id="themeToggle" style="width:100%;">Switch to Light Mode</button>
                </div>
                <div>
                    <label>Gemini API Key</label>
                    <div class="input-with-btn">
                        <input type="password" id="geminiKeyInput" placeholder="Enter API Key">
                        <button class="test-btn" id="testGeminiBtn" onclick="testGeminiAPI()">Test</button>
                    </div>
                </div>
                <div>
                    <label>Ollama URL</label>
                    <div class="input-with-btn">
                        <input type="text" id="ollamaUrlInput" placeholder="http://127.0.0.1:11434">
                        <button class="test-btn" id="testOllamaBtn" onclick="testOllamaAPI()">Test</button>
                    </div>
                </div>
                <div>
                    <label>Paired Devices</label>
                    <div id="pairedList" class="paired-list">
                        <!-- Dynamic -->
                        <div class="paired-item" style="justify-content:center; color:var(--text-secondary);">No devices
                            paired.</div>
                    </div>
                </div>
                <div>
                    <label>Default Provider</label>
                    <select id="defaultProviderSelect">
                        <option value="ollama">Ollama</option>
                        <option value="gemini">Gemini</option>
                    </select>
                </div>
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
                    <button onclick="closeSettings()"
                        style="background:transparent; border:1px solid var(--border); color:var(--text-secondary); padding:12px 20px; border-radius:8px;">Close</button>
                    <button class="primary-btn" onclick="saveSettings()"
                        style="padding:12px 20px; border-radius:8px;">Save Configuration</button>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================================
         PAIRING REQUEST MODAL
         ========================================= -->
    <div class="modal-backdrop" id="pairingModal">
        <div class="modal-content" style="max-width:400px; text-align:center; padding:30px;">
            <div style="margin-bottom:20px;">
                <i class="ph ph-plugs-connected" style="font-size:3rem; color:var(--accent);"></i>
            </div>
            <h3>Pairing Request</h3>
            <p id="pairingRequestMsg" style="margin:10px 0 25px; color:var(--text-secondary);">Device "Unknown" wants to
                pair with you.</p>

            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="primary-btn" onclick="acceptPairing()" style="background:#22c55e;">Accept</button>
                <button class="primary-btn" onclick="rejectPairing()" style="background:#ef4444;">Decline</button>
            </div>
        </div>
    </div>

    <!-- =========================================
         LIVE PREVIEW MODAL
         ========================================= -->
    <div class="modal-backdrop" id="previewModal">
        <div class="modal-content"
            style="max-width:98vw; width:fit-content; height: fit-content; display:flex; flex-direction:column;">
            <div class="modal-body"
                style="display:flex; flex-direction:column; align-items:center; justify-content: center; position: relative; padding: 0;">
                <video id="remoteVideo" class="preview-large" autoplay playsinline muted></video>
                <!-- Floating Capture Button -->
                <button id="remoteCaptureBtn" title="Take Picture"><i class="ph ph-camera"></i></button>
            </div>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast">
        <i class="ph ph-check-circle" style="font-size:1.2rem; color:var(--accent);"></i>
        <span id="toastMsg">Action Successful</span>
    </div>

    <!-- App Script -->
    <script src="/script.js"></script>
</body>

</html>